<!doctype html>
<html>

<head>
    <title>Spreadbase</title>
</head>

<style>
    #viewport {
        float: left;
        border: 1px solid black;
        overflow: auto;
        width: 350px;
    }

    #content {
        position: relative;
        overflow: hidden;
    }

    .row {
        position: absolute;
        left: 0px;
        width: 100%;
        border-bottom: 1px dotted blue;
        font-size: 9pt;
    }

    .row:hover {
        background: rgba(0, 0, 255, 0.05);
    }
</style>

<body>
    <div id="viewport">
        <div id="content"></div>
    </div>
</body>

<script>
    const itemCount = 1000000000;
    const rowHeight = 50;
    const virtualHeight = rowHeight * itemCount;
    const scrollableHeight = 1000000;
    const pageHeight = scrollableHeight / 100;
    const numberOfPages = Math.ceil(virtualHeight / pageHeight);
    const viewportHeight = 400;
    const jumpinessCoefficient = (virtualHeight - scrollableHeight) / (numberOfPages - 1);

    let page = 0;
    let pageOffset = 0;
    let prevScrollTop = 0;

    let rows = {};

    const viewport = document.getElementById("viewport");
    const content = document.getElementById("content");

    viewport.style.height = `${viewportHeight}px`;
    content.style.height = `${scrollableHeight}px`;

    viewport.addEventListener("scroll", onScroll);

    onScroll();

    function onScroll() {
        const scrollTop = viewport.scrollTop;

        if (Math.abs(scrollTop - prevScrollTop) > viewportHeight) {
            onJump();
        }
        else {
            onNearScroll();
        }

        renderViewport();
    }

    function onNearScroll() {
        const scrollTop = viewport.scrollTop;

        // next page
        if (scrollTop + pageOffset > (page + 1) * pageHeight) {
            page++;
            pageOffset = Math.round(page * jumpinessCoefficient);
            viewport.scrollTop(prevScrollTop = scrollTop - jumpinessCoefficient);
            removeAllRows();
        }
        // prev page
        else if (scrollTop + pageOffset < page * pageHeight) {
            page--;
            pageOffset = Math.round(page * jumpinessCoefficient);
            viewport.scrollTop(prevScrollTop = scrollTop + jumpinessCoefficient);
            removeAllRows();
        }
        else {
            prevScrollTop = scrollTop;
        }
    }

    function onJump() {
        const scrollTop = viewport.scrollTop;
        page = Math.floor(scrollTop * ((virtualHeight - viewportHeight) / (scrollableHeight - viewportHeight)) * (1 / pageHeight));
        pageOffset = Math.round(page * jumpinessCoefficient);
        prevScrollTop = scrollTop;

        removeAllRows();
    }

    function removeAllRows() {
        for (var i in rows) {
            rows[i].remove();
            delete rows[i];
        }
    }

    function renderViewport() {
        // calculate the viewport + buffer
        const y = viewport.scrollTop + pageOffset;
        const buffer = viewportHeight;
        const top = Math.max(0, Math.floor((y - buffer) / rowHeight));
        const bottom = Math.min(virtualHeight / rowHeight, Math.ceil((y + viewportHeight + buffer) / rowHeight));

        // remove rows no longer in the viewport
        for (var i in rows) {
            if (i < top || i > bottom) {
                rows[i].remove();
                delete rows[i];
            }
        }

        // add new rows
        for (var i = top; i <= bottom; i++) {
            if (!rows[i])
                rows[i] = renderRow(i);
        }
    }

    function renderRow(row) {
        const rowElement = document.createElement("div");
        rowElement.className = "row";
        rowElement.style.cssText = `top: ${row * rowHeight - pageOffset}px; height: ${rowHeight}px;`;
        rowElement.innerText = "row " + (row);
        content.append(rowElement);
        return rowElement;
    }
</script>

</html>